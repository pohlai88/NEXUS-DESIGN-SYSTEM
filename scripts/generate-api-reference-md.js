#!/usr/bin/env node
/**
 * Generate API Reference Markdown Documentation
 * 
 * Generates markdown API reference from dist/api-docs.json
 * Output: docs/API_REFERENCE.md
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join } from 'path';

const distDir = join(process.cwd(), 'dist');
const apiDocsFile = join(distDir, 'api-docs.json');
const outputFile = join(process.cwd(), 'docs', 'API_REFERENCE.md');

if (!existsSync(apiDocsFile)) {
  console.error('❌ api-docs.json not found. Run: pnpm extract:api-docs');
  process.exit(1);
}

const apiDocs = JSON.parse(readFileSync(apiDocsFile, 'utf-8'));

function generateMarkdown() {
  const timestamp = new Date().toISOString();
  
  let markdown = `# API Reference

> **Auto-generated** from \`dist/api-docs.json\`  
> **Last updated**: ${timestamp}  
> **Source**: Design system classes and components

---

## Overview

This document provides a complete API reference for the Neo-Analog Design System.

**Design System**: ${apiDocs.designSystem.name} v${apiDocs.designSystem.version}  
**Description**: ${apiDocs.designSystem.description}

---

`;

  // Typography
  if (apiDocs.typography) {
    markdown += generateTypographySection(apiDocs.typography);
  }

  // Components
  if (apiDocs.components) {
    markdown += generateComponentsSection(apiDocs.components);
  }

  // Layout
  if (apiDocs.layout) {
    markdown += generateLayoutSection(apiDocs.layout);
  }

  // Tokens
  if (apiDocs.tokens) {
    markdown += generateTokensSection(apiDocs.tokens);
  }

  // Classes
  if (apiDocs.classes && apiDocs.classes.length > 0) {
    markdown += generateClassesSection(apiDocs.classes);
  }

  // Exports
  if (apiDocs.exports) {
    markdown += generateExportsSection(apiDocs.exports);
  }

  markdown += `
---

## Usage

### CSS Classes

All classes can be used directly in HTML:

\`\`\`html
<h1 class="na-h1">Page Title</h1>
<div class="na-card na-p-6">Card Content</div>
<button class="na-btn-primary">Submit</button>
\`\`\`

### JavaScript/TypeScript

\`\`\`typescript
import { Button, Card } from '@aibos/design-system/react';
\`\`\`

---

**Generated by**: \`scripts/generate-api-reference-md.js\`  
**Source**: \`dist/api-docs.json\`
`;

  return markdown;
}

function generateTypographySection(typography) {
  let section = `## Typography

### Headings

| Class | Size | Weight | Line Height | Usage |
|-------|------|--------|-------------|-------|
`;

  if (typography.headings) {
    typography.headings.forEach(h => {
      section += `| \`${h.class}\` | ${h.size} | ${h.weight} | ${h.lineHeight} | ${h.usage} |\n`;
    });
  }

  section += `\n### Data & Metadata\n\n| Class | Size | Weight | Font | Usage |\n|-------|------|--------|------|-------|\n`;

  if (typography.data) {
    typography.data.forEach(d => {
      section += `| \`${d.class}\` | ${d.size} | ${d.weight} | ${d.font} | ${d.usage} |\n`;
    });
  }

  section += '\n';
  return section;
}

function generateComponentsSection(components) {
  let section = `## Components

`;

  if (components.cards) {
    section += `### Cards\n\n| Class | Description | Example |\n|-------|-------------|---------|\n`;
    components.cards.forEach(c => {
      section += `| \`${c.class}\` | ${c.description} | \`${c.example}\` |\n`;
    });
    section += '\n';
  }

  if (components.buttons) {
    section += `### Buttons\n\n| Class | Description | Example |\n|-------|-------------|---------|\n`;
    components.buttons.forEach(b => {
      section += `| \`${b.class}\` | ${b.description} | \`${b.example}\` |\n`;
    });
    section += '\n';
  }

  if (components.status) {
    section += `### Status\n\n| Class | Description | Example |\n|-------|-------------|---------|\n`;
    components.status.forEach(s => {
      section += `| \`${s.class}\` | ${s.description} | \`${s.example}\` |\n`;
    });
    section += '\n';
  }

  return section;
}

function generateLayoutSection(layout) {
  let section = `## Layout

`;

  if (layout.shell) {
    section += `### Shell\n\n| Class | Description | Example |\n|-------|-------------|---------|\n`;
    layout.shell.forEach(s => {
      section += `| \`${s.class}\` | ${s.description} | \`${s.example}\` |\n`;
    });
    section += '\n';
  }

  if (layout.grid) {
    section += `### Grid\n\n| Class | Description | Example |\n|-------|-------------|---------|\n`;
    layout.grid.forEach(g => {
      section += `| \`${g.class}\` | ${g.description} | \`${g.example}\` |\n`;
    });
    section += '\n';
  }

  return section;
}

function generateTokensSection(tokens) {
  let section = `## Design Tokens

`;

  if (tokens.colors) {
    if (tokens.colors.base) {
      section += `### Base Colors\n\n| Token | Value | Usage |\n|-------|-------|-------|\n`;
      tokens.colors.base.forEach(c => {
        section += `| \`${c.token}\` | \`${c.value}\` | ${c.usage} |\n`;
      });
      section += '\n';
    }

    if (tokens.colors.status) {
      section += `### Status Colors\n\n| Token | Value | Usage |\n|-------|-------|-------|\n`;
      tokens.colors.status.forEach(c => {
        section += `| \`${c.token}\` | \`${c.value}\` | ${c.usage} |\n`;
      });
      section += '\n';
    }
  }

  return section;
}

function generateClassesSection(classes) {
  let section = `## Utility Classes

| Class | Category | Description |
|-------|----------|-------------|
`;

  classes.forEach(c => {
    section += `| \`${c.name}\` | ${c.category} | ${c.description} |\n`;
  });

  section += '\n';
  return section;
}

function generateExportsSection(exports) {
  let section = `## Package Exports

| Export | Description |
|--------|-------------|
`;

  const exportDescriptions = {
    css: 'Main CSS file',
    tokens: 'Design tokens JSON',
    tokensTypescript: 'Design tokens TypeScript types',
    react: 'React components',
    types: 'TypeScript type definitions',
    utils: 'Utility functions',
    cli: 'CLI tools',
  };

  Object.entries(exports).forEach(([key, value]) => {
    const description = exportDescriptions[key] || 'Package export';
    section += `| \`${value}\` | ${description} |\n`;
  });

  section += '\n';
  return section;
}

// Generate and write
try {
  const markdown = generateMarkdown();
  writeFileSync(outputFile, markdown, 'utf-8');
  console.log('✅ API reference generated: docs/API_REFERENCE.md');
} catch (error) {
  console.error('❌ Error generating API reference:', error.message);
  process.exit(1);
}


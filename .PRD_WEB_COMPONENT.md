Refer: C:\AI-BOS\AIBOS-DESIGN-SYSTEM\.web-components-control.json

# Product Requirements Document (PRD)
## Web Components Adapter System

**Version**: 1.2.0  
**Date**: 2026-01-03  
**Status**: ✅ Approved (Enterprise-Grade)  
**Owner**: AIBOS Design System Team

> **Critical Refinements Applied**: Generator/Runtime split, Light DOM enforcement, Event naming contract, Runtime build task  
> **Enterprise Best Practices Added (v1.2.0)**: Error handling, Type-safe events, Tree-shaking, Automated a11y testing, Bundle monitoring

---

## 1. Executive Summary

### 1.1 Objective

Implement a Web Components adapter system that generates zero-dependency Web Components from the same component specifications used for React components, enabling:
- React components for dynamic apps (existing)
- Web Components for static HTML pages (new)
- Both from a single source of truth (JSON specs)
- Both using Radix UI accessibility patterns

### 1.2 Business Value

- Performance: 0KB React overhead for static HTML pages
- Governance: Single source of truth prevents drift
- Flexibility: Right tool for the right page
- Maintainability: One spec, multiple outputs
- Future-proof: Extensible to Vue, Svelte, Angular

### 1.3 Success Criteria

- Generate Web Components from existing JSON specs
- Web Components match React component functionality (accessibility, behavior)
- Zero React dependency for HTML pages
- 95% test coverage (aligned with project standards)
- Full TypeScript support
- Documentation complete

---

## 2. Architecture

### 2.1 System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Component Specifications                │
│              specs/components/*.json (SSOT)                 │
└──────────────────────┬──────────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌──────────────────┐          ┌──────────────────┐
│  React Adapter   │          │  Web Components   │
│  (Existing)      │          │  Adapter (NEW)    │
└────────┬─────────┘          └────────┬─────────┘
         │                               │
         ▼                               ▼
┌──────────────────┐          ┌──────────────────┐
│  Radix UI React  │          │  Radix Primitives │
│  @radix-ui/*     │          │  (Vanilla JS)     │
└──────────────────┘          └──────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────┐          ┌──────────────────┐
│  React Components│          │  Web Components  │
│  dist/react/*.tsx│          │  dist/web/*.js   │
└──────────────────┘          └──────────────────┘
```

### 2.2 Component Flow

1. Component Spec (JSON) → Universal Adapter Interface
2. Framework Adapter → Generates framework-specific code
3. Radix Primitives → Provides accessibility logic
4. Generated Component → Production-ready code

### 2.3 Key Design Principles

1. Single Source of Truth: JSON specs define behavior once
2. Parallel Generation: Same spec → multiple frameworks
3. Radix Governance: All components use Radix accessibility patterns
4. Zero Dependencies: Web Components have no framework overhead
5. Type Safety: Full TypeScript support throughout
6. Error Resilience: Error boundaries and graceful degradation
7. Tree-Shaking: ES module exports for optimal bundle sizes
8. Type-Safe Events: Strongly typed CustomEvent definitions

---

## 3. Directory Structure

### 3.1 Proposed Structure (Optimized)

```
adapters/
├── index.ts                    # Adapter registry (update to include web)
├── universal/
│   ├── adapter.ts              # UniversalAdapter interface (existing)
│   ├── errors.ts               # Error classes (existing)
│   └── validation.ts           # Zod schemas (existing)
├── react/
│   ├── adapter.ts              # React adapter (existing)
│   └── utils.ts                # React utilities (existing)
└── web/                        # NEW
    ├── generator/              # Build-time code (Node.js)
    │   └── adapter.ts          # Generator that reads specs, writes files
    └── runtime/                # Browser-time code (compiled to dist/web/lib/)
        ├── primitives.ts       # Radix UI logic port (vanilla JS)
        └── utils.ts            # Runtime utilities

dist/
├── adapters/
│   ├── react/                  # Existing React components
│   └── web/                    # NEW: Generated Web Components
│       ├── na-dialog.js
│       ├── na-button.js
│       ├── na-dropdown.js
│       ├── index.js
│       └── lib/                # NEW: Compiled runtime library
│           ├── primitives.js   # Compiled from adapters/web/runtime/
│           └── utils.js        # Compiled from adapters/web/runtime/
└── components/
    └── web/                    # NEW: Compiled Web Components
        └── index.d.ts          # TypeScript definitions

specs/
└── components/                 # Existing (SSOT)
    ├── dialog.json
    ├── button.json
    └── ...

tests/
└── adapters/
    ├── react/                  # Existing React tests
    └── web/                    # NEW: Web Components tests
        ├── adapter.test.ts
        ├── primitives.test.ts
        └── integration.test.ts

scripts/
├── generate-adapter.ts         # Update to support web
└── build-components.ts         # Update to support web
```

### 3.2 File Responsibilities

#### `adapters/web/generator/adapter.ts`
- Purpose: Web Components generator (implements `UniversalAdapter`)
- Runtime: Node.js (build-time)
- Responsibilities:
  - Generate Web Component class code
  - Handle component parts (composite components)
  - Apply AIBOS classes from specs
  - Generate TypeScript definitions
  - Import runtime library from `dist/web/lib/`
- Size: ~300-500 lines

#### `adapters/web/runtime/primitives.ts`
- Purpose: Radix UI accessibility logic port (vanilla JS)
- Runtime: Browser (runs in user's browser)
- Output: Compiled to `dist/web/lib/primitives.js`
- Responsibilities:
  - Focus trap implementation
  - ARIA attribute management
  - Keyboard event handling
  - Focus restoration
  - Escape key handling
- Size: ~200-500 lines (reusable across all components)
- **Build**: Must be compiled to ES modules for browser consumption

#### `adapters/web/runtime/utils.ts`
- Purpose: Web Components runtime utilities
- Runtime: Browser (runs in user's browser)
- Output: Compiled to `dist/web/lib/utils.js`
- Responsibilities:
  - Class name merging (AIBOS + custom)
  - Attribute helpers
  - Event handling utilities
- Size: ~50-100 lines

---

## 4. Tech Stack

### 4.1 Core Technologies

| Technology | Version | Purpose |
|------------|---------|---------|
| **TypeScript** | ^5.6.0 | Type safety, code generation |
| **Web Components API** | Native | Custom Elements, Shadow DOM (optional) |
| **Vitest** | ^2.1.8 | Testing framework |
| **Zod** | ^3.25.76 | Runtime validation |
| **pnpm** | v8+ | Package manager |
| **Turborepo** | Latest | Task runner (monorepo) |

### 4.2 Dependencies

**Runtime Dependencies:**
- None (Web Components are native)

**Dev Dependencies:**
- `@types/node` - Node.js types
- `vitest` - Testing
- `@vitest/ui` - Test UI
- `@vitest/coverage-v8` - Coverage reports

**No New Dependencies Required** (Web Components are native browser APIs)

**Build Process:**
- Generator code (`adapters/web/generator/`) runs at build time (Node.js)
- Runtime code (`adapters/web/runtime/`) must be compiled to `dist/web/lib/` for browser consumption
- New build command: `pnpm build:runtime` (transpiles runtime TS → dist/web/lib/*.js)

### 4.3 Build Tools

- **TypeScript Compiler** (`tsc`) - Compile TypeScript
- **Custom Scripts** (`scripts/generate-adapter.ts`) - Code generation
- **PostCSS** (existing) - CSS processing

---

## 5. Technical Specifications

### 5.1 Error Handling Strategy

**Error Boundaries**: All Web Components must implement error boundaries to prevent silent failures.

```typescript
// adapters/web/runtime/error-handling.ts
export function withErrorBoundary(
  component: HTMLElement,
  onError: (error: Error, context: string) => void
): () => void {
  const errorHandler = (event: ErrorEvent) => {
    event.preventDefault();
    onError(new Error(event.message), event.filename || 'unknown');
    component.dispatchEvent(new CustomEvent('na-error', {
      bubbles: true,
      detail: { error: event.message, source: event.filename }
    }));
  };
  
  window.addEventListener('error', errorHandler);
  return () => window.removeEventListener('error', errorHandler);
}
```

**Graceful Degradation**: Components should degrade gracefully if primitives fail to load.

```typescript
// Generated component pattern
class NaDialog extends HTMLElement {
  async connectedCallback() {
    try {
      const { DialogPrimitive } = await import('./lib/primitives.js');
      this.setupDialog(DialogPrimitive);
    } catch (error) {
      console.warn('Dialog primitives failed to load, using fallback');
      this.setupDialogFallback();
    }
  }
}
```

### 5.2 Type-Safe Event System

**Event Type Definitions**: All events must have TypeScript definitions.

```typescript
// Generated: dist/web/na-dialog.d.ts
export interface NaDialogEvents {
  'na-open': CustomEvent<{ open: boolean; timestamp: number }>;
  'na-close': CustomEvent<{ reason: 'escape' | 'click-outside' | 'programmatic' }>;
  'na-error': CustomEvent<{ error: string; source: string }>;
}

declare global {
  interface HTMLElementEventMap extends NaDialogEvents {}
}
```

**Event Dispatch Pattern**: Use typed event dispatcher.

```typescript
// Runtime utility
export function dispatchTypedEvent<T extends keyof HTMLElementEventMap>(
  element: HTMLElement,
  eventName: T,
  detail: HTMLElementEventMap[T] extends CustomEvent<infer D> ? D : never
): boolean {
  const event = new CustomEvent(eventName, {
    bubbles: true,
    cancelable: true,
    detail
  });
  return element.dispatchEvent(event);
}
```

### 5.3 Tree-Shaking Support

**ES Module Exports**: All runtime code must use ES modules for tree-shaking.

```typescript
// dist/web/lib/index.js
export { DialogPrimitive } from './primitives.js';
export { FocusPrimitive } from './primitives.js';
export { AriaPrimitive } from './primitives.js';
export { cn, dispatchNaEvent } from './utils.js';

// Individual exports enable tree-shaking
// Consumer: import { DialogPrimitive } from '@aibos/design-system/web/lib'
```

**Bundle Analysis**: Automated bundle size monitoring.

```json
// package.json
{
  "bundlesize": [
    {
      "path": "dist/web/lib/primitives.js",
      "maxSize": "20KB"
    },
    {
      "path": "dist/web/lib/utils.js",
      "maxSize": "5KB"
    }
  ]
}
```

### 5.4 Automated Accessibility Testing

**Integration**: Use axe-core for automated a11y testing.

```typescript
// tests/adapters/web/a11y.test.ts
import { axe, toHaveNoViolations } from 'jest-axe';
import { render } from '@testing-library/react';

expect.extend(toHaveNoViolations);

describe('Web Components Accessibility', () => {
  it('should have no a11y violations', async () => {
    const { container } = render('<na-dialog open>Content</na-dialog>');
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

**CI/CD Integration**: Run a11y tests in CI pipeline.

```yaml
# .github/workflows/a11y.yml
- name: Run Accessibility Tests
  run: pnpm test:coverage -- --grep "a11y"
```

### 5.5 Web Component Structure

**Critical: Light DOM Strategy**

Web Components must use **Light DOM** (or Open Shadow DOM) to inherit global `style.css` tokens. Shadow DOM blocks global styles.

```typescript
// Generated: dist/web/na-dialog.js
import { DialogPrimitive } from './lib/primitives.js';

class NaDialog extends HTMLElement {
  static get observedAttributes() {
    return ['open', 'variant', 'size'];
  }

  constructor() {
    super();
    // CRITICAL: No Shadow DOM - use Light DOM to inherit style.css
    this.open = false;
    this.previousFocus = null;
  }

  connectedCallback() {
    this.setupDialog();
  }

  disconnectedCallback() {
    this.cleanup();
  }

  attributeChangedCallback(name: string, oldValue: string, newValue: string) {
    if (name === 'open') {
      this.open = newValue !== null;
      this.updateDialog();
    }
  }

  // Radix UI logic (from runtime/primitives.ts, compiled to lib/primitives.js)
  setupDialog() {
    DialogPrimitive.setAriaAttributes(this, { open: this.open });
    DialogPrimitive.setupFocusTrap(this);
    DialogPrimitive.handleEscape(this, () => this.close());
  }

  open() {
    this.open = true;
    this.setAttribute('open', '');
    // Dispatch custom event: 'na-open' (not 'open' to avoid native event collision)
    this.dispatchEvent(new CustomEvent('na-open', { bubbles: true }));
    DialogPrimitive.trapFocus(this);
  }

  close() {
    this.open = false;
    this.removeAttribute('open');
    // Dispatch custom event: 'na-close'
    this.dispatchEvent(new CustomEvent('na-close', { bubbles: true }));
    DialogPrimitive.restoreFocus(this.previousFocus);
  }
}

customElements.define('na-dialog', NaDialog);
```

**Event Naming Contract:**
- React prop: `onOpenChange` → Web Component event: `na-open-change`
- React prop: `onValueChange` → Web Component event: `na-value-change`
- All events prefixed with `na-` to avoid native event collisions

### 5.2 Radix Primitives Port

```typescript
// adapters/web/runtime/primitives.ts
// This file runs in the browser (compiled to dist/web/lib/primitives.js)

export const DialogPrimitive = {
  trapFocus(element: HTMLElement): () => void {
    // Focus trap logic (from Radix UI)
    // Returns cleanup function
  },

  setAriaAttributes(element: HTMLElement, props: DialogProps): void {
    // ARIA management
  },

  handleEscape(element: HTMLElement, onClose: () => void): () => void {
    // Escape key handling
  },

  restoreFocus(previousFocus: HTMLElement | null): void {
    // Focus restoration
  }
};
```

**Build Process:**
- Source: `adapters/web/runtime/primitives.ts`
- Output: `dist/web/lib/primitives.js` (ES module)
- Command: `pnpm build:runtime`
- Generated components import: `import { DialogPrimitive } from './lib/primitives.js';`

### 5.3 Component Spec Integration

```json
// specs/components/dialog.json (existing, no changes needed)
{
  "name": "Dialog",
  "radixPrimitive": "@radix-ui/react-dialog",
  "variants": {
    "default": {
      "aibosClasses": ["na-modal"]
    }
  },
  "parts": {
    "Trigger": { "aibosClasses": ["na-btn"] },
    "Content": { "aibosClasses": ["na-modal__panel"] }
  }
}
```

---

## 6. Definition of Done (DoD)

### 6.1 Functional Requirements

- [ ] Web Components adapter implements `UniversalAdapter` interface
- [ ] Generates Web Components from existing JSON specs
- [ ] Web Components support all variants and states from specs
- [ ] Web Components apply AIBOS classes correctly
- [ ] Composite components (with parts) generate correctly
- [ ] Radix UI accessibility patterns implemented in vanilla JS
- [ ] Web Components work in HTML shells (no React required)
- [ ] TypeScript definitions generated for Web Components
- [ ] Event Translation: React props (onValueChange) map to native CustomEvents (value-change)
- [ ] Light DOM Strategy: Components use Light DOM or Open Shadow DOM to inherit global style.css tokens

### 6.2 Quality Requirements

- [ ] 95% test coverage (unit + integration tests)
- [ ] All tests passing (`pnpm test`)
- [ ] TypeScript compilation successful (`pnpm build:ts`)
- [ ] No linting errors (`pnpm lint`)
- [ ] No TypeScript errors
- [ ] Code follows project style guide
- [ ] All generated code validated

### 6.3 Documentation Requirements

- [ ] `adapters/web/README.md` - Web Components adapter guide
- [ ] `docs/WEB_COMPONENTS_GUIDE.md` - Usage guide for consumers
- [ ] JSDoc comments on all public APIs
- [ ] Examples in HTML shells
- [ ] Migration guide (if applicable)
- [ ] API reference updated

### 6.4 Integration Requirements

- [ ] Adapter registered in `adapters/index.ts`
- [ ] Build script updated (`scripts/generate-adapter.ts`)
- [ ] Package.json exports updated
- [ ] TypeScript config updated (if needed)
- [ ] CI/CD pipeline updated (if applicable)

### 6.5 Performance Requirements

- [ ] Web Components bundle size < 50KB (gzipped)
- [ ] Zero React dependency for HTML pages
- [ ] Initial load time < 100ms (for HTML pages)
- [ ] No memory leaks (tested with DevTools)

### 6.6 Accessibility Requirements

- [ ] WCAG AAA compliant
- [ ] Keyboard navigation works
- [ ] Screen reader compatible
- [ ] Focus management correct
- [ ] ARIA attributes correct
- [ ] Automated a11y tests passing (axe-core, pa11y)
- [ ] A11y violations caught in CI/CD

### 6.7 Error Handling Requirements

- [ ] Error boundaries for runtime failures
- [ ] Graceful degradation on primitive load failure
- [ ] Error events dispatched (`na-error`)
- [ ] Console warnings for development
- [ ] Error recovery mechanisms documented

### 6.8 Type Safety Requirements

- [ ] TypeScript event definitions generated
- [ ] Type-safe CustomEvent interfaces
- [ ] Event detail types exported
- [ ] IntelliSense support for events
- [ ] Type checking in CI/CD

### 6.9 Bundle Optimization Requirements

- [ ] ES module exports for tree-shaking
- [ ] Individual primitive exports
- [ ] Bundle size monitoring in CI/CD
- [ ] Bundle analyzer reports generated
- [ ] Tree-shaking validation tests

---

## 7. Key Performance Indicators (KPIs)

### 7.1 Development KPIs

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Test Coverage** | ≥95% | `pnpm test:coverage` |
| **TypeScript Errors** | 0 | `tsc --noEmit` |
| **Linting Errors** | 0 | `pnpm lint` |
| **Build Time** | <30s | `pnpm build` |
| **Code Generation Time** | <5s | `pnpm generate:adapter web` |

### 7.2 Quality KPIs

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Generated Code Validation** | 100% | Automated checks |
| **Component Spec Compliance** | 100% | All specs generate correctly |
| **Accessibility Score** | AAA | WCAG audit |
| **Browser Compatibility** | Chrome 105+, Firefox 121+, Safari 15.4+ | Manual testing |

### 7.3 Performance KPIs

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Web Component Bundle Size** | <50KB gzipped | Bundle analyzer |
| **HTML Page Load Time** | <100ms | Lighthouse |
| **Zero React Overhead** | 0KB React | Bundle analyzer |
| **Memory Usage** | No leaks | DevTools Memory Profiler |
| **Tree-Shaking Efficiency** | >80% unused code removed | Bundle analyzer |
| **Bundle Size Regression** | <5% increase | CI/CD monitoring |

### 7.4 Quality & Reliability KPIs

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Error Rate** | <0.1% runtime errors | Error tracking |
| **A11y Violations** | 0 critical, <5 warnings | Automated a11y tests |
| **Type Safety** | 100% typed events | TypeScript compiler |
| **Error Recovery** | 100% graceful degradation | Manual testing |

### 7.4 Adoption KPIs

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Components Generated** | All 12+ components | Count in `dist/web/` |
| **HTML Shells Using Web Components** | 3+ examples | Manual review |
| **Documentation Completeness** | 100% | Checklist review |

---

## 8. Critical Control Points (Drift Prevention)

### 8.1 Pre-Development Checkpoints

#### Checkpoint 1: Architecture Alignment
- [ ] Verify alignment with Universal Adapter pattern
- [ ] Confirm no breaking changes to existing React adapter
- [ ] Validate directory structure matches project standards
- [ ] Review tech stack compatibility

**Gate**: Architecture review approval required before coding

#### Checkpoint 2: Spec Validation
- [ ] All existing specs validated (`pnpm validate:specs`)
- [ ] Specs compatible with Web Components generation
- [ ] No spec changes required (Web Components use same specs)

**Gate**: Spec validation passing

### 8.2 Development Checkpoints

#### Checkpoint 3: Primitives Implementation
- [ ] Radix UI logic ported correctly
- [ ] All accessibility patterns implemented
- [ ] Unit tests for primitives (≥95% coverage)
- [ ] Code review: primitives match Radix behavior

**Gate**: Primitives tests passing + code review

#### Checkpoint 4: Adapter Generator
- [ ] Adapter implements `UniversalAdapter` interface
- [ ] Generates valid Web Components code
- [ ] Handles all component types (simple, composite)
- [ ] Unit tests for adapter (≥95% coverage)

**Gate**: Adapter tests passing + code review

#### Checkpoint 5: Component Generation
- [ ] Generate first component (Dialog) successfully
- [ ] Generated code validates (syntax, exports)
- [ ] Component works in HTML shell
- [ ] Integration test passing

**Gate**: First component working + integration test passing

### 8.3 Quality Checkpoints

#### Checkpoint 6: Code Quality
- [ ] TypeScript compilation successful
- [ ] No linting errors
- [ ] Code formatted (Prettier)
- [ ] All tests passing

**Gate**: Quality checks passing

#### Checkpoint 7: Test Coverage
- [ ] Unit tests: ≥95% coverage
- [ ] Integration tests: All scenarios covered
- [ ] Accessibility tests: All patterns tested
- [ ] Browser compatibility: Tested in target browsers

**Gate**: Coverage ≥95% + all tests passing

#### Checkpoint 8: Documentation
- [ ] README.md complete
- [ ] Usage guide complete
- [ ] API reference updated
- [ ] Examples provided

**Gate**: Documentation review approval

### 8.4 Integration Checkpoints

#### Checkpoint 9: Build Integration
- [ ] Build script updated
- [ ] Package.json exports updated
- [ ] TypeScript config updated (if needed)
- [ ] CI/CD pipeline updated (if applicable)

**Gate**: Build successful + exports working

#### Checkpoint 10: HTML Shell Integration
- [ ] Web Components work in HTML shells
- [ ] No React dependency required
- [ ] Performance meets targets
- [ ] Accessibility verified

**Gate**: HTML shell integration working + performance verified

### 8.5 Pre-Release Checkpoints

#### Checkpoint 11: Full Component Generation
- [ ] All 12+ components generate successfully
- [ ] All components tested
- [ ] All components work in HTML shells
- [ ] No regressions in React adapter

**Gate**: All components working + no regressions

#### Checkpoint 12: Final Validation
- [ ] All DoD items complete
- [ ] All KPIs met
- [ ] Code review approved
- [ ] Documentation complete
- [ ] Release notes prepared

**Gate**: Final approval for release

---

## 9. Risk Mitigation

### 9.1 Technical Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Radix logic port complexity** | High | Start with Dialog (most complex), create reusable primitives |
| **Browser compatibility** | Medium | Test in target browsers, use polyfills if needed |
| **Performance overhead** | Low | Measure bundle size, optimize primitives |
| **TypeScript definition generation** | Medium | Use existing patterns from React adapter |

### 9.2 Process Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Drift from React adapter** | High | Use same specs, automated validation |
| **Incomplete documentation** | Medium | Documentation checkpoints, review process |
| **Test coverage gaps** | Medium | Coverage targets, automated checks |

---

## 10. Implementation Phases

### Phase 1: Foundation & Runtime (Week 1)
- Create `adapters/web/` directory structure (generator/ and runtime/)
- Implement `runtime/primitives.ts` (Dialog, Focus, ARIA)
- Configure build for runtime library (`pnpm build:runtime`)
- Unit tests for primitives
- **Gate**: Primitives working + runtime library built + tests passing

### Phase 2: Adapter Generator (Week 1-2)
- Implement `adapters/web/generator/adapter.ts`
- Generate simple component (Button) with Light DOM
- Implement event naming contract (na-* prefix)
- Unit tests for adapter
- **Gate**: Adapter generating valid code with proper event handling

### Phase 3: First Component (Week 2)
- Generate Dialog component
- Integration test
- HTML shell example
- **Gate**: Dialog working in HTML shell

### Phase 4: Full Generation (Week 2-3)
- Generate all 12+ components
- Integration tests for all
- HTML shell examples
- **Gate**: All components working

### Phase 5: Polish & Release (Week 3)
- Documentation
- Final testing
- Performance optimization
- Release preparation
- **Gate**: All DoD items complete

---

## 11. Success Metrics

### 11.1 Immediate Success
- ✅ Web Components generate from existing specs
- ✅ Zero React dependency for HTML pages
- ✅ 95% test coverage achieved
- ✅ All components working in HTML shells

### 11.2 Long-term Success
- ✅ Web Components adopted in HTML shells
- ✅ Reduced bundle size for static pages
- ✅ Maintained single source of truth
- ✅ Foundation for Vue/Svelte/Angular adapters

---

## 12. Approval & Sign-off

**PRD Status**: ✅ Ready for Review

**Next Steps**:
1. Review and approve PRD
2. Assign development team
3. Begin Phase 1: Foundation
4. Schedule checkpoint reviews

---

**Document Version**: 1.1.0  
**Last Updated**: 2026-01-03  
**Next Review**: After Phase 1 completion

---

## 13. Critical Refinements Applied

### 13.0 Version History

- **v1.1.0** (2026-01-03): Initial PRD with Generator/Runtime split, Light DOM, Event naming, Runtime build
- **v1.2.0** (2026-01-03): Enterprise best practices added (Error handling, Type-safe events, Tree-shaking, A11y automation, Bundle monitoring)

### 13.1 Critical Refinements (v1.1.0)

### 13.1 Generator vs. Runtime Architecture Split

**Problem**: Generator code (Node.js) and runtime code (browser) were mixed.

**Solution**: 
- Generator: `adapters/web/generator/` (runs at build time)
- Runtime: `adapters/web/runtime/` (compiled to `dist/web/lib/` for browser)

**Impact**: Clear separation of concerns, proper build process.

### 13.2 Light DOM Strategy Enforcement

**Problem**: Shadow DOM blocks global `style.css` tokens (Beast Mode styling).

**Solution**: 
- Enforce Light DOM or Open Shadow DOM
- Components inherit global Design System tokens
- No style duplication required

**Impact**: Web Components work seamlessly with existing `style.css`.

### 13.3 Event Naming Contract

**Problem**: React props (`onOpenChange`) need to map to native events.

**Solution**: 
- Standard: `na-{action}` (e.g., `na-open`, `na-close`, `na-value-change`)
- React prop `onOpenChange` → Web Component event `na-open-change`
- Prevents native event collisions

**Impact**: Future framework compatibility (Vue, Svelte, Angular).

### 13.4 Runtime Build Task

**Problem**: Runtime code needs to be compiled for browser consumption.

**Solution**: 
- New build command: `pnpm build:runtime`
- Transpiles `adapters/web/runtime/*.ts` → `dist/web/lib/*.js`
- Generated components import from `./lib/primitives.js`

**Impact**: Proper dependency linking, browser-compatible code.

---

This PRD aligns with your existing architecture, maintains your quality standards (95% test coverage), and includes critical control points to prevent drift. Ready for your review and approval.